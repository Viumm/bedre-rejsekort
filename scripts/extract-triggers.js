import { neon } from '@neondatabase/serverless';
import { writeFileSync } from 'fs';
import { config } from 'dotenv';

config({ path: '.env.local' });

async function extractTriggers() {
  if (!process.env.DATABASE_URL) {
    throw new Error('DATABASE_URL is not defined in .env.local');
  }

  const sql = neon(process.env.DATABASE_URL);

  try {
    
    const result = await sql`
      SELECT 
        n.nspname AS schema_name,
        t.tgname AS trigger_name,
        c.relname AS table_name,
        pg_get_triggerdef(t.oid) AS trigger_definition
      FROM pg_trigger t
      JOIN pg_class c ON t.tgrelid = c.oid
      JOIN pg_namespace n ON c.relnamespace = n.oid
      WHERE n.nspname NOT IN ('information_schema', 'pg_catalog', 'pg_toast')
      AND NOT t.tgisinternal
      ORDER BY c.relname, t.tgname;
    `;

    const triggers = result;
    
    let triggerFileContent = `-- PostgreSQL Triggers
-- Auto-generated by extract-triggers.js
-- Run: pnpm run db:extract-triggers

`;

    // Group triggers by table
    const triggersByTable = {};
    triggers.forEach(trigger => {
      if (!triggersByTable[trigger.table_name]) {
        triggersByTable[trigger.table_name] = [];
      }
      triggersByTable[trigger.table_name].push(trigger);
    });

    Object.entries(triggersByTable).forEach(([tableName, tableTriggers]) => {
      triggerFileContent += `-- Triggers for table: ${tableName}\n`;
      
      tableTriggers.forEach(trigger => {
        triggerFileContent += `${trigger.trigger_definition};\n\n`;
      });
      
      triggerFileContent += `\n`;
    });

    writeFileSync('./src/lib/database/triggers.sql', triggerFileContent);
    console.log(`Extracted ${triggers.length} triggers to src/lib/database/triggers.sql`);
    
  } catch (error) {
    console.error('Error extracting triggers:', error);
    console.error('Error details:', error.message);
    process.exit(1);
  }
}

extractTriggers();

