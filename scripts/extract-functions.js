import { neon } from '@neondatabase/serverless';
import { writeFileSync } from 'fs';
import { config } from 'dotenv';

config({ path: '.env.local' });

async function extractFunctions() {
  if (!process.env.DATABASE_URL) {
    throw new Error('DATABASE_URL is not defined in .env.local');
  }

  const sql = neon(process.env.DATABASE_URL);

  try {
    
    const result = await sql`
      SELECT 
        p.proname AS function_name,
        pg_get_functiondef(p.oid) AS function_definition,
        n.nspname AS schema_name
      FROM pg_proc p
      JOIN pg_namespace n ON p.pronamespace = n.oid
      WHERE n.nspname NOT IN ('information_schema', 'pg_catalog', 'pg_toast')
      AND p.proname NOT LIKE 'drizzle_%'
      ORDER BY n.nspname, p.proname;
    `;

    const functions = result;
    
    let functionFileContent = `-- PostgreSQL Functions
-- Auto-generated by extract-functions.js
-- Run: pnpm run db:extract-functions

`;

    functions.forEach(func => {
      functionFileContent += `-- Function: ${func.schema_name}.${func.function_name}
${func.function_definition}

`;
    });

    writeFileSync('./src/lib/database/functions.sql', functionFileContent);
    console.log(`Extracted ${functions.length} functions to src/lib/database/functions.sql`);
    
  } catch (error) {
    console.error('Error extracting functions:', error);
    process.exit(1);
  }
}

extractFunctions(); 