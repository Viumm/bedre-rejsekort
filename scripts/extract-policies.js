import { neon } from '@neondatabase/serverless';
import { writeFileSync } from 'fs';
import { config } from 'dotenv';

config({ path: '.env.local' });

async function extractPolicies() {
  if (!process.env.DATABASE_URL) {
    throw new Error('DATABASE_URL is not defined in .env.local');
  }

  const sql = neon(process.env.DATABASE_URL);

  try {
    
    const result = await sql`
      SELECT 
        schemaname,
        tablename,
        policyname,
        permissive,
        roles,
        cmd,
        qual,
        with_check
      FROM pg_policies
      WHERE schemaname = 'public'
      ORDER BY tablename, policyname;
    `;

    const policies = result;
    
    let policyFileContent = `-- PostgreSQL Row Level Security Policies
-- Auto-generated by extract-policies.js  
-- Run: pnpm run db:extract-policies

`;

    // Group policies by table
    const policiesByTable = {};
    policies.forEach(policy => {
      if (!policiesByTable[policy.tablename]) {
        policiesByTable[policy.tablename] = [];
      }
      policiesByTable[policy.tablename].push(policy);
    });

    Object.entries(policiesByTable).forEach(([tableName, tablePolicies]) => {
      policyFileContent += `-- Policies for table: ${tableName}
ALTER TABLE ${tableName} ENABLE ROW LEVEL SECURITY;

`;
      
      tablePolicies.forEach(policy => {
        const permissive = policy.permissive === 'PERMISSIVE' ? 'AS PERMISSIVE' : 'AS RESTRICTIVE';
        
        // Fix roles handling - check if it's array or string
        let roles;
        if (Array.isArray(policy.roles)) {
          roles = policy.roles.join(', ');
        } else if (typeof policy.roles === 'string') {
          // Remove curly braces if present and split by comma
          roles = policy.roles.replace(/[{}]/g, '').split(',').map(r => r.trim()).join(', ');
        } else {
          roles = 'public'; // fallback
        }
        
        const command = policy.cmd || 'ALL';
        
        policyFileContent += `CREATE POLICY "${policy.policyname}"
  ON ${tableName}
  ${permissive}
  FOR ${command}
  TO ${roles}`;
        
        if (policy.qual) {
          policyFileContent += `
  USING (${policy.qual})`;
        }
        
        if (policy.with_check) {
          policyFileContent += `
  WITH CHECK (${policy.with_check})`;
        }
        
        policyFileContent += `;

`;
      });
      
      policyFileContent += `\n`;
    });

    writeFileSync('./src/lib/database/policies.sql', policyFileContent);
    console.log(`Extracted ${policies.length} RLS policies to src/lib/database/policies.sql`);
    
  } catch (error) {
    console.error('Error extracting policies:', error);
    console.error('Error details:', error.message);
    process.exit(1);
  }
}

extractPolicies(); 